<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<title>W3.CSS Template</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" th:href="@{/css/w3.css}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.css" rel="stylesheet">
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.js"></script>
<!-- include summernote css/js-->
<link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.11/summernote-bs4.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.11/summernote-bs4.js"></script>
<!-- include summernote-ko-KR -->
<script th:src="@{/js/summernote-ko-KR.js}"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">

<body class="w3-content" style="max-width:1200px">
<th:block th:replace="/blog/fragment/sidebar.html :: sidebar"></th:block>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:250px; background-color: rgba(0,0,0,.2);">
    <th:block th:replace="/blog/fragment/topbar.html :: topbar"></th:block>
    <th:block th:replace="/blog/fragment/categoryList.html :: categoryList"></th:block>
</div>
<div class="w3-main w3-row" style="margin-left:250px; margin-top: 20px; background-color: rgba(0,0,0,.2);">
    <form method="post" th:object="${blogContent}" th:action="@{/{blogTitle}/content/add(blogTitle=${blogTitle})}"
          enctype="multipart/form-data">
        <input type="text" name="title" th:field="*{id}" th:value="*{id}==0?:*{id}" hidden>
        <div style="display: flex;">
            <p style="margin-left:20px; padding-top: 5px; margin-right:15px;">카테고리</p>
            <select name="blogCategory.id">
                <option th:each=" blogCategory: ${blogCategories}" th:text="${blogCategory.title}"
                        th:value="${blogCategory.id}" th:selected="${#strings.equals(blogCategory.id,blogCategoryId)}">
                </option>
            </select>
            <p style="margin-left:20px; padding-top: 5px; margin-right:15px;">공개 여부</p>
            <select th:field="*{locked}">
                <option th:text="'공개'" th:value="false" th:selected="*{locked==false}">
                </option>
                <option th:text="'비공개'" th:value="true" th:selected="*{locked==true}">
                </option>
            </select>
        </div>
        <div style="display: flex;">
            <p style="margin-left:20px; padding-top: 5px; margin-right:40px;">제목</p><input type="text" name="title"
                                                                                           th:field="*{title}">
            <input type="text" name="blogTitle" th:field="*{blogTitle}" th:value="${blogTitle}" hidden>
        </div>
        <input type="text" name="see" th:field="*{see}" th:value="*{see}" hidden>
        <textarea class="summernote" id="summernote" name="text" th:field="*{text}"></textarea>
        <ul style="list-style:none; padding-left:0px; margin: 10px;">
            <li class="filebox bs3-primary preview-image">
                <div class="upload-display" th:if="${thumbnail1}!=null"><div class="upload-thumb-wrap"><img th:src="@{/thumbnail/{thumbnail}(thumbnail=${thumbnail1.storeFileName})}" class="upload-thumb"></div></div>
                <label for="input_file">썸네일 선텍</label>
                <input class="upload-name" th:value="${thumbnail1}==null?'파일 이름':${thumbnail1.uploadFileName}" disabled="disabled" style="width: 200px;">
                <input type="file" name="thumbnail1" accept="image/*" id="input_file" class="upload-hidden">
            </li>
            <li>첨부파일 <input type="file" name="uploadFiles1" multiple="multiple"></li>
        </ul>
        <span>남은 입력 수: </span> <span id="maxContentPost"></span>
        <input name="saveBtn" class="button btn-2" style="width: 100%;" type="button" value="저장"
               onclick="goWrite(this.form)">
    </form>
</div>

<script type="text/javascript" th:src="@{/js/functionEditorAndView.js}"></script>
<script th:inline="javascript">
    $(document).ready(function(){
        var fileTarget = $('.filebox .upload-hidden');
        fileTarget.on('change', function(){
            if(window.FileReader){
                // 파일명 추출
                var filename = $(this)[0].files[0].name;
            }

            else {
                // Old IE 파일명 추출
                var filename = $(this).val().split('/').pop().split('\\').pop();
            };

            $(this).siblings('.upload-name').val(filename);
        });

        //preview image
        var imgTarget = $('.preview-image .upload-hidden');

        imgTarget.on('change', function(){
            var parent = $(this).parent();
            parent.children('.upload-display').remove();

            if(window.FileReader){
                //image 파일만
                if (!$(this)[0].files[0].type.match(/image\//)) return;

                var reader = new FileReader();
                reader.onload = function(e){
                    var src = e.target.result;
                    parent.prepend('<div class="upload-display"><div class="upload-thumb-wrap"><img src="'+src+'" class="upload-thumb"></div></div>');
                }
                reader.readAsDataURL($(this)[0].files[0]);
            }

            else {
                $(this)[0].select();
                $(this)[0].blur();
                var imgSrc = document.selection.createRange().text;
                parent.prepend('<div class="upload-display"><div class="upload-thumb-wrap"><img class="upload-thumb"></div></div>');

                var img = $(this).siblings('.upload-display').find('img');
                img[0].style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(enable='true',sizingMethod='scale',src=\""+imgSrc+"\")";
            }
        });
    });
    function registerSummernote(element, placeholder, max, callbackMax) {
        $(element).summernote({
            maximumImageFileSize: 5242880,
            dialogInBody: true,
            placeholder: '내용을 작성하세요',
            height: 400,
            callbacks: {
                onKeydown: function (e) {
                    var t = e.currentTarget.innerText;
                    if (t.length >= max) {
                        //delete key
                        if (e.keyCode != 8)
                            e.preventDefault();
                        // add other keys ...
                    }
                },
                onKeyup: function (e) {
                    var t = e.currentTarget.innerText;
                    if (typeof callbackMax == 'function') {
                        callbackMax(max - t.length);
                    }
                },
                onPaste: function (e) {
                    var t = e.currentTarget.innerText;
                    var bufferText = ((e.originalEvent || e).clipboardData || window.clipboardData).getData('Text');
                    e.preventDefault();
                    var all = t + bufferText;
                    document.execCommand('insertText', false, all.trim().substring(0, 4000));
                    if (typeof callbackMax == 'function') {
                        callbackMax(max - t.length);
                    }
                }
            }
        });
    }


    $(function () {
        registerSummernote('.summernote', 'Leave a comment', 4000, function (max) {
            $('#maxContentPost').text(max)
        });
    });
    $("input[type=file]").bind('change', function (e) {
        if (!$(this).val()) return;

        var f = this.files[0];
        var size = f.size || f.fileSize;

        var limit = 10000000;

        //alert( id + ' / ' + limit );

        if (size > limit) {
            alert('파일용량은 10mb 를 넘을수 없습니다.');
            $(this).val('');
            return;
        }

        $(this).parent().find('input[type=text]').val($(this).val());
    })

    function goWrite(frm) {
        var title = frm.title.value;
        var text = frm.text.value;
        var leng = document.getElementById('maxContentPost').textContent;
        if (title.trim() == '') {
            alert("제목을 입력해주세요");
            return false;
        }
        if (text.trim() == '') {
            alert("본문을 입력해주세요");
            return false;
        }
        if (leng < 0) {
            alert("너무 깁니다.");
            return false;
        }
        frm.submit();
    }
</script>
</body>

</html>